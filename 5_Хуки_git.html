<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
  "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
	<title>Git Book - Хуки Git</title>
	<meta http-equiv="content-language" content="en">
	<meta http-equiv="content-type" content="text/html; charset=UTF-8">
	<link rel="icon" href="favicon.png" type="image/png">
	<link rel="stylesheet" href="assets/blueprint/screen.css" type="text/css" media="screen, projection">
  <link rel="stylesheet" href="assets/blueprint/print.css" type="text/css" media="print">
  <!--[if IE]><link rel="stylesheet" href="assets/blueprint/ie.css" type="text/css" media="screen, projection"><![endif]-->
	<link rel="stylesheet" href="assets/stylesheets/mac_classic.css" type="text/css" media="screen, projection">
	<link rel="stylesheet" href="assets/stylesheets/style.css" type="text/css" media="screen, projection">
</head>

<body>
<div class="container chapter showgrids">

  <div class="span-21 header">
    <div class="nav"><a href="5_Настройка_git.html">Prev</a>  <a href="5_Востановление_поврежденных_объектов.html">Next</a></div>
    <div class="title"><a href='index.html'>Git Community Book</a></div>
  </div>
  
  <div class="span-21">
    <br/>
  </div>
  
  <div class="span-21">
    <h2>Хуки Git</h2>

<p>Хуки это короткие скрипты которые вы можете разместить в директории $GIT_DIR/hooks и которые будут запускаться по определенному событию. Когда выполняется git-init, то набор хуков идущих в комплекте с git копируется в директорию hooks нового репозитория, но по умолчанию они деактивированы. Чтобы активировать хуки, их следует переименовать, удалив их расширение .sample.</p>

<h3>applypatch-msg</h3>

<pre><code>GIT_DIR/hooks/applypatch-msg
</code></pre>

<p>Этот хук вызывается скриптом git-am. Он принимает единственный параметр - имя файла, который содержит лог сообщение коммита. Выход с ненулевым статусом прерывает процесс выполнения команды git-am до наложения патча.</p>

<p>Хуку разрешается редактировать файл сообщение, и он может быть использован чтобы составить сообщение в особом формате, стандартном для проекта(если таковой формат имеется). Он также может быть использован чтобы отказаться от коммита после проверки файла сообщения.
Хук по умолчанию applypatch-msg, когда разблокирован, запускает хук commit-msg, если последний разблокирован.</p>

<h3>pre-applypatch</h3>

<pre><code>GIT_DIR/hooks/pre-applypatch
</code></pre>

<p>Этот хук вызывается git-am. Он не берет аргументы, и вызывается после того как патч уже наложен, но до того как будет выполнен коммит.
Если он завершается с ненулевым статусом, тогда коммит рабочего дерева не будет выполнен после наложения патча.</p>

<p>Он может быть использован для проверки текущего рабочего дерева и может отказать в выполнении коммита если оно не пройдет определенные тесты.
По умолчанию pre-applypatch хук, когда разблокирован, выполняет хук pre-commit, если последний разблокирован.</p>

<h3>post-applypatch</h3>

<pre><code>GIT_DIR/hooks/post-applypatch
</code></pre>

<p>Этот хук вызывается 'git-am'. Он не берет параметров, и вызывается после того как наложен патч и выполнен коммит.</p>

<p>Назначение хука главным образом уведомление, и не может влиять на последствия выполнения 'git-am'.</p>

<h3>pre-commit</h3>

<pre><code>GIT_DIR/hooks/pre-commit
</code></pre>

<p>Этот хук вызывается 'git-commit', и его вызов может быть отменен с помощью параметра <code>\--no-verify</code>. Он не берет параметров, и активируется до получения предложения лог-сообщения коммита и выполнения коммита. Завершение скрипта с ненулевым статусом прервет выполнение 'git-commit'.</p>

<p>Дефолтовый 'pre-commit' хук, когда разблокирован, ловит ввод строк с пробелами в окончании и прерывает коммит когда такая строка найдена.</p>

<p>Все хуки 'git-commit' вызываются с переменной окружения <code>GIT_EDITOR=:</code> если команда не вызывает редактор чтобы модифицировать сообщение-описпние коммита.</p>

<p>Здесь пример Ruby скрипта который выполняет тесты RSpec перед тем как позволить выполнить коммит.</p>

<pre class="mac_classic">  
html_path <span class="Keyword">=</span> <span class="String"><span class="String">&quot;</span>spec_results.html<span class="String">&quot;</span></span>  
<span class="String"><span class="String">`</span>spec -f h:<span class="StringInterpolation"><span class="StringInterpolation">#{</span>html_path<span class="StringInterpolation">}</span></span> -f p spec<span class="String">`</span></span> <span class="Comment"><span class="Comment">#</span> run the spec. send progress to screen. save html results to html_path  </span>

<span class="Comment"><span class="Comment">#</span> find out how many errors were found  </span>
html <span class="Keyword">=</span> <span class="FunctionName">open</span>(html_path).<span class="FunctionName">read</span>  
examples <span class="Keyword">=</span> html.<span class="FunctionName">match</span>(<span class="String"><span class="String">/</span></span><span class="String"><span class="String"><span class="String">(</span><span class="StringInterpolation">\d</span>+<span class="String">)</span></span> examples</span><span class="String"><span class="String">/</span></span>)[<span class="Number">0</span>].<span class="FunctionName">to_i</span> <span class="Keyword">rescue</span> <span class="Number">0</span>  
failures <span class="Keyword">=</span> html.<span class="FunctionName">match</span>(<span class="String"><span class="String">/</span></span><span class="String"><span class="String"><span class="String">(</span><span class="StringInterpolation">\d</span>+<span class="String">)</span></span> failures</span><span class="String"><span class="String">/</span></span>)[<span class="Number">0</span>].<span class="FunctionName">to_i</span> <span class="Keyword">rescue</span> <span class="Number">0</span>  
pending <span class="Keyword">=</span> html.<span class="FunctionName">match</span>(<span class="String"><span class="String">/</span></span><span class="String"><span class="String"><span class="String">(</span><span class="StringInterpolation">\d</span>+<span class="String">)</span></span> pending</span><span class="String"><span class="String">/</span></span>)[<span class="Number">0</span>].<span class="FunctionName">to_i</span> <span class="Keyword">rescue</span> <span class="Number">0</span>  

<span class="Keyword">if</span> failures.<span class="FunctionName">zero?</span>  
  puts <span class="String"><span class="String">&quot;</span>0 failures! <span class="StringInterpolation"><span class="StringInterpolation">#{</span>examples<span class="StringInterpolation">}</span></span> run, <span class="StringInterpolation"><span class="StringInterpolation">#{</span>pending<span class="StringInterpolation">}</span></span> pending<span class="String">&quot;</span></span>  
<span class="Keyword">else</span>  
  puts <span class="String"><span class="String">&quot;</span><span class="StringInterpolation">\a</span>DID NOT COMMIT YOUR FILES!<span class="String">&quot;</span></span>  
  puts <span class="String"><span class="String">&quot;</span>View spec results at <span class="StringInterpolation"><span class="StringInterpolation">#{</span><span class="LibraryObject">File</span><span class="StringInterpolation"><span class="StringInterpolation">.</span><span class="FunctionName">expand_path</span></span><span class="StringInterpolation">(</span>html_path<span class="StringInterpolation">)</span><span class="StringInterpolation">}</span></span><span class="String">&quot;</span></span>  
  puts  
  puts <span class="String"><span class="String">&quot;</span><span class="StringInterpolation"><span class="StringInterpolation">#{</span>failures<span class="StringInterpolation">}</span></span> failures! <span class="StringInterpolation"><span class="StringInterpolation">#{</span>examples<span class="StringInterpolation">}</span></span> run, <span class="StringInterpolation"><span class="StringInterpolation">#{</span>pending<span class="StringInterpolation">}</span></span> pending<span class="String">&quot;</span></span>  
  exit <span class="Number">1</span>  
<span class="Keyword">end</span>
</pre>

<h3>prepare-commit-msg</h3>

<pre><code>GIT_DIR/hooks/prepare-commit-msg
</code></pre>

<p>Этот хук активируется 'git-commit' сразу после подготовки дефолтного лога сообщения, и перед тем как откроется редактор.</p>

<p>Он берет от одного до трех параметров. Первый это имя файла содержащего сообщение-описание коммита. Второй источник сообщения коммита, и может быть: 'message' (если параметри <code>-m</code> или <code>-F</code> был передан ); <code>template</code> (если параметр <code>-t</code> был передан или установлен параметр настройки <code>commit.template</code>); <code>merge</code> (если коммит это слияние или существует файл <code>.git/MERGE_MSG</code>); <code>squash</code> (если существует файл <code>.git/SQUASH_MSG</code>); или <code>commit</code>, со следующим за ним SHA1 значением коммита (если передан параметр <code>-c</code>, <code>-C</code> или <code>\--ammend</code>)..</p>

<p>Если статус окончания работы ненулевой, выполнение 'git-commit' прервется.</p>

<p>Цель хука отредактировать файл сообщение на месте, и это не подавляется передачей параметра <code>\--no-verify</code>. Ненулевой статус окончания выполнения означает сбой хука и прерывание коммита. Он не должен быть использован как замена хука pre-commit.</p>

<p>Образец хука <code>prepare-commit-msg</code> который поставляется с комментариями git вне части <code>Conflicts:</code> сообщения описания коммита слияния.</p>

<h3>commit-msg</h3>

<pre><code>GIT_DIR/hooks/commit-msg
</code></pre>

<p>Этот хук вызывается 'git-commit', и может быть обойден с помощью параметра <code>\--no-verify</code>. Он берет единственный параметр, имя файла который содержит предполагаемое сообщение описание коммита. Выход с ненулевым статусом прерывает выполнение 'git-commit'.</p>

<p>Этому хуку позоволяется редактировать файл сообщение на месте, и он может быть испльзован чтобы привести сообщение в стандартный вид для проекта(если таковой имеется). Он также может быть использован чтобы отказаться от коммита после проверки файла сообщения.</p>

<p>Хук по умолчания 'commit-msg', когда активирован, определяет дубликаты строк
"Signed-off-by", и прерывает коммит если найдет таковую.</p>

<h3>post-commit</h3>

<pre><code>GIT_DIR/hooks/post-commit
</code></pre>

<p>Этот хук вызывается 'git-commit'. Он не берет параметров, о вызывается после того как коммит уже завершен.</p>

<p>Назначение этого хука главным образом уведомление, и он не может повлиять на результат работы 'git-commit'.</p>

<h3>pre-rebase</h3>

<pre><code>GIT_DIR/hooks/pre-rebase
</code></pre>

<p>Этот хук вызывается 'git-rebase' и может быть использован чтобы предотвратить выполнение операции ребазирования в ветке.</p>

<h3>post-checkout</h3>

<pre><code>GIT_DIR/hooks/post-checkout
</code></pre>

<p>Этот хук вызывается когда 'git-checkout' выполняется после обновления рабочего дерева. Хук требуется три параметра: ссылка на предыдущую HEAD, ссылка на новую HEAD (которая возможно была изменена а возможно и нет), и флаг показывающий была ли операция checkout с веткой (смена ветки, flag=1) или она была проведена над файлом (получение файла из индекса, flag=0). Этот хук не может повлиять на результат 'git-checkout'.</p>

<p>Этот хук может быть использован чтобы выполнять проверки правильности репозитория валидность, автоматический показ отличий от предыдущей HEAD если отличается, или набор свойств метаданных рабочей директории.</p>

<h3>post-merge</h3>

<pre><code>GIT_DIR/hooks/post-merge
</code></pre>

<p>Этот хук вызывается 'git-merge', что происходит когда 'git-pull' закончил свою работу в локальном репозитории. Хук берет единственный аргумент, флаг статуса определяющий было или нет выполненное слияние squash слиянием. Этот хук не может влиять на результат 'git-merge' и не выполняется если слияние потерпело неудачу вследствии конфликтов.</p>

<p>Этот хук может быть использован совместно с соотвествующим хуком pre-commit чтобы сохранять и восстанавливать метаданные ассоциированные с рабочим деревом в любой форме (в т.ч. разрешения/владение, ACLS и т.д.) Просмотрите contrib/hooks/setgitperms.perl чтобы на примере изучить как проделывать это.</p>

<h3>pre-receive</h3>

<pre><code>GIT_DIR/hooks/pre-receive
</code></pre>

<p>Этот хук вызывается 'git-receive-pack' на удаленный репозиторий, что происходит когда заканчивается выполнение 'git-push' на локальном репозитории.
Сразу после начала обновления refs(сслылок) на удаленном репозитории, вызывается хук pre-receive. Его статус выхода определяет успех или неудачу обновления.</p>

<p>Этот хук выполняется однажды для операции получения. Он не принимает аргументов, но чтобы обновить каждую ref(ссылку) он принимает в стандартный ввод строку след.формата:</p>

<p>  <old-value> SP <new-value> SP <ref-name> LF</p>

<p>где <code>&lt;old-value&gt;</code> это старое имя объекта сохраненного в ref, <code>&lt;new-value&gt;</code> это имя нового объекта который будет сохранен в ref и <code>&lt;ref-name&gt;</code> это полное имя ref. Когда создается новая ref, <code>&lt;old-value&gt;</code> принимает значение 40 <code>0</code>.</p>

<p>Если хук завершает выполнение с ненулевым статусом, ни одна из refs(ссылок) будет обновлена. Если хук завершится с нулевым статусом, то обновление индивидуальных refs все еще можно предотвратить хуком &lt;&lt;update,'update'>>.</p>

<p>Оба стандарный вывод и стандартный вывод ошибок перенаправлены на 'git-send-pack' на другой стороне, так что вы можете просто посылать <code>echo</code> сообщения для пользователя.</p>

<p>Если вы написали его на Руби, вы можете получить аргументы след.образом:</p>

<pre class="mac_classic">
rev_old, rev_new, ref <span class="Keyword">=</span> <span class="Variable">STDIN</span>.<span class="FunctionName">read</span>.<span class="FunctionName">split</span>(<span class="String"><span class="String">&quot;</span> <span class="String">&quot;</span></span>)
</pre>

<p>Или в bash скрипт, аналогичный тому что ниже тоже будет работать:</p>

<pre><code>#!/bin/sh
# &lt;oldrev&gt; &lt;newrev&gt; &lt;refname&gt;
# update a blame tree
while read oldrev newrev ref
do
    echo "STARTING [$oldrev $newrev $ref]"
    for path in `git diff-tree -r $oldrev..$newrev | awk '{print $6}'`
    do
      echo "git update-ref refs/blametree/$ref/$path $newrev"
      `git update-ref refs/blametree/$ref/$path $newrev`
    done
done
</code></pre>

<h3>update</h3>

<pre><code>GIT_DIR/hooks/update
</code></pre>

<p>Этот хук вызывается 'git-receive-pack' на удаленном репозитории, что происходит когда выполнение 'git-push' завершилось на локальном репозитории. Перед самым обновлением ссылок на удаленном репозитории, вызывается хук обновления. Его статус окончания выполнения определяет успешно или неудачно обновилась ссылка.</p>

<p>Этот хук выполняется один раз для обновления каждой ссылки, и он принимает три параметра:</p>

<ul>
<li>имя обновляемой ссылки,</li>
<li>имя старого объекта хранящегося в ссылке,</li>
<li>и новое имя объекта которое сохранится в ссылке.</li>
</ul>


<p>Нулевой выход из хука обновления позволяет обновиться ссылке. Выход с ненулевым статусом предотвратит обновление этой ссылки хуком 'git-receive-pack'</p>

<p>Этот хук может быть использован чтобы предотвратить 'forced(вынужденное)' обновление определенных ссылок, с помощью проверки что имени объекта соотвествует объект коммит, который является потомоком объекта коммита названного по имени старого объекта. Это для того чтобы заставить работать правило "только fast-forwarding".</p>

<p>Он также может быть использован что логгировать старый..новый статус. Как бы там ни было, он не знает все множество ветвей, и закончит посылая одно эл.сообщение на каждую обновленную ссылку, когда используется напрямую. Хук
&lt;&lt;post-receive,'post-receive'>> лучше подходит для этого.</p>

<p>Другое использование предложеное в списке рассылки, использовать этот хук чтобы реализовать контроль доступа, который будет лучше гранулирован чем тот что используется на основе групп в файловой системе.</p>

<p>Оба стандартный вывод и стандартные вывод ошибок перенаправлены с другого конца в 'git-send-pack', так что вы легко можете <code>посылать echo</code> сообщения для пользователя.</p>

<p>Хук 'update' по умолчанию, когда активирован--и с включенным конфигурационным параметром <code>hooks.allowunannotated</code>--предотвращает выполнение push неаннотированных тагов.</p>

<h3>post-receive</h3>

<pre><code>GIT_DIR/hooks/post-receive
</code></pre>

<p>Этот хук вызывается 'git-receive-pack' на удаленном репозитории, что происходит когда завершается 'git-push' на локальном репозитории. Он выполняется на удаленном репозитории один раз после того как все ссылки будут обновлены.</p>

<p>Этот хук выполняется один раз для операции получения. Он не принимает аргументов, но получает туже информацию что и хук &lt;&lt;pre-receive,'pre-receive'>> на его стандартный ввод.</p>

<p>Этот хук не влияет на результат 'git-receive-pack', так как он вызывается после того как работа фактически уже окончена.</p>

<p>Он замещает хук &lt;&lt;post-update,'post-update'>> таким образом, он получает оба старые и новые значения всех ссылок в добавок к их именам.</p>

<p>Оба стандартный вывод и стандартный вывод ошибок перенаправлены с другой стороны на 'git-send-pack', так что вы можете просто посылать <code>echo</code> сообщения пользователю.</p>

<p>Дефолтовый хук 'post-receive' пуст, но существует скрипт образец <code>post-receive-email</code> в директории <code>contrib/hooks</code> идущий по умолчанию в комплекте с git, который реализует отпраление коммитов по эл.почте.</p>

<h3>post-update</h3>

<pre><code>GIT_DIR/hooks/post-update
</code></pre>

<p>Этот хук вызвается 'git-receive-pack' на удаленном репозитории, и происходит когда завершается выполнение 'git-push' на локальном репозитории.
Он выполняется на удаленном репозитории один раз после того как все ссылки будут обновлены.</p>

<p>Он берет переменное число параметров, каждый из которых это имя ссылки которая фактически была обновлена.</p>

<p>Это хук главным образом назначается для уведомлений, и не может повлиять на результат 'git-receive-pack'.</p>

<p>Хук 'post-update' может сообщить для каких HEAD было выполнена операция push, но он не знает каковы их оригинальные и обновленные значения, так что это не самое лучшее место чтобы логировать. Хук &lt;&lt;post-receive,'post-receive'>> получает оба оригинальные и обновленные значения ссылок. Вам лучше использовать его если они вам нужны.</p>

<p>Когда активирован, хук 'post-update' по умолчанию запускает 'git-update-server-info' чтобы поддерживать информацию обновленной использованную транспотными протоколами (e.g., HTTP). Если вы публикуете репозиториий git который доступен по протоколу HTTP, то возможно вы должны разрешить этот хук.</p>

<p>Оба стандартный вывод и стандартный вывод ошибок перенаправлены на 'git-send-pack' с другого конца, так что вы можете просто посылать <code>echo</code> сообщения для пользователя.</p>

<h3>pre-auto-gc</h3>

<pre><code>GIT_DIR/hooks/pre-auto-gc
</code></pre>

<p>Это хук вызывается 'git-gc --auto'. Он не принимает параметров, и выход с ненулевым статусом из этого скрипта вызывает прекращение работы 'git-gc --auto'.</p>

<h3>References</h3>

<p><a href="http://www.kernel.org/pub/software/scm/git/docs/githooks.html">Git Hooks</a>
* http://probablycorey.wordpress.com/2008/03/07/git-hooks-make-me-giddy/</p>

<p>Недопереведено</p>


  </div>
  
  <div class="span-21">
    <hr/>
    <div class="center"><a href="5_Настройка_git.html">Prev</a>  <a href="5_Востановление_поврежденных_объектов.html">Next</a></div>
    <hr/>
  </div>
  
  <div class="span-17 footer">
  	<div class="menu">
  		This book is maintained by Scott Chacon, and hosting is donated by GitHub.
  		<br>
  		Please email me at <a href="mailto:schacon@gmail.com">schacon@gmail.com</a>
  		with patches, suggestions and comments.
	  </div>
  </div>
  <div class="span-4 last center">
    <a href="http://github.com"><img src="assets/images/github.png" alt="github logo"></a>
  </div>
  
</div>

<script type="text/javascript">
var pageTracker = _gat._getTracker("UA-82337-12");
pageTracker._initData();
pageTracker._trackPageview();
</script>
<script src="http://static.getclicky.com/40584.js" type="text/javascript"></script>
<noscript><p><img alt="Clicky" src="http://in.getclicky.com/40584-db6.gif" /></p></noscript>

</body>
</html>
