<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
  "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
	<title>Git Book - Протоколы передачи</title>
	<meta http-equiv="content-language" content="en">
	<meta http-equiv="content-type" content="text/html; charset=UTF-8">
	<link rel="icon" href="favicon.png" type="image/png">
	<link rel="stylesheet" href="assets/blueprint/screen.css" type="text/css" media="screen, projection">
  <link rel="stylesheet" href="assets/blueprint/print.css" type="text/css" media="print">
  <!--[if IE]><link rel="stylesheet" href="assets/blueprint/ie.css" type="text/css" media="screen, projection"><![endif]-->
	<link rel="stylesheet" href="assets/stylesheets/mac_classic.css" type="text/css" media="screen, projection">
	<link rel="stylesheet" href="assets/stylesheets/style.css" type="text/css" media="screen, projection">
</head>

<body>
<div class="container chapter showgrids">

  <div class="span-21 header">
    <div class="nav"><a href="7_raw_git.html">Prev</a>  <a href="7_Глоссарий.html">Next</a></div>
    <div class="title"><a href='index.html'>Git Community Book</a></div>
  </div>
  
  <div class="span-21">
    <br/>
  </div>
  
  <div class="span-21">
    <h2>Протоколы передачи</h2>

<p>Здесь мы узнаем как клиенты и серверы общаются друг с другом и обмениваются данными Git между собой.</p>

<h3>Извлечение данных через HTTP</h3>

<p>Извлечение через http/s URL заставит Git использовать немного глупый протокол. В этом случае, вся логика ложится на сторону клиента. Сервер не требует специальной настройки - любой статический вебсервер подойдет для этой работы если директори git которую вы извлекает доступна вебсерверу.</p>

<p>Чтобы это работало, вам нужно выполнять единственную команду на репозитории сервера каждый раз если что то обновилось, команда выглядит след.образом <a href="http://www.kernel.org/pub/software/scm/git/docs/git-update-server-info.html">git update-server-info</a>, которая обновляет файлы objects/info/packs и info/refs чтобы составить список какие ссылки и пакфайлы досупны, так как вы не можете изменить этот список через http. Когда эта команда выполняется, файл objects/info/packs выглядит приблизительно след.образом:</p>

<pre><code>P pack-ce2bd34abc3d8ebc5922dc81b2e1f30bf17c10cc.pack
P pack-7ad5f5d05f5e20025898c95296fe4b9c861246d8.pack
</code></pre>

<p>Так что если извлечение не может найти свободный(loosy) файл, то оно может попробовать эти пакфайлы. Файл info/refs приблизительно будет выглядеть след.образом:</p>

<pre><code>184063c9b594f8968d61a686b2f6052779551613    refs/heads/development
32aae7aef7a412d62192f710f2130302997ec883    refs/heads/master
</code></pre>

<p>Потом когда вы извлекаете из этого репозитория, то процесс начнет с этих refs и пройдет объекты коммит до тех пор пока клиет не получит все объекты которые ему нужны.</p>

<p>Например, если вы попросите извлечь ветку master, то видно что ветка master указывает на <code>32aae7ae</code> а ваша ветка master указывает на <code>ab04d88</code>, так что вам нужно <code>32aae7ae</code>. Вы извлекаете этот объект</p>

<pre><code>CONNECT http://myserver.com
GET /git/myproject.git/objects/32/aae7aef7a412d62192f710f2130302997ec883 - 200
</code></pre>

<p>И это выглядит след.образом:</p>

<pre><code>tree aa176fb83a47d00386be237b450fb9dfb5be251a
parent bd71cad2d597d0f1827d4a3f67bb96a646f02889
author Scott Chacon &lt;schacon@gmail.com&gt; 1220463037 -0700
committer Scott Chacon &lt;schacon@gmail.com&gt; 1220463037 -0700

added chapters on private repo setup, scm migration, raw git
</code></pre>

<p>Теперь это извлекает дерево <code>aa176fb8</code>:</p>

<pre><code>GET /git/myproject.git/objects/aa/176fb83a47d00386be237b450fb9dfb5be251a - 200
</code></pre>

<p>которе выглядет след.образом:</p>

<pre><code>100644 blob 6ff87c4664981e4397625791c8ea3bbb5f2279a3    COPYING
100644 blob 97b51a6d3685b093cfb345c9e79516e5099a13fb    README
100644 blob 9d1b23b8660817e4a74006f15fae86e2a508c573    Rakefile
</code></pre>

<p>И теперь это извлекает эти объекты:</p>

<pre><code>GET /git/myproject.git/objects/6f/f87c4664981e4397625791c8ea3bbb5f2279a3 - 200
GET /git/myproject.git/objects/97/b51a6d3685b093cfb345c9e79516e5099a13fb - 200
GET /git/myproject.git/objects/9d/1b23b8660817e4a74006f15fae86e2a508c573 - 200
</code></pre>

<p>В действительности это происходит с помощью Curl, и может открываться множество паралельных потоков чтобы ускорить процесс. Когда процесс заканчивает рекурсию дерева указанного коммитом, оно извлекает следующего родителя.</p>

<pre><code>GET /git/myproject.git/objects/bd/71cad2d597d0f1827d4a3f67bb96a646f02889 - 200
</code></pre>

<p>Теперь в этом случае, коммит который вернулся выглядет след.образом:</p>

<pre><code>tree b4cc00cf8546edd4fcf29defc3aec14de53e6cf8
parent ab04d884140f7b0cf8bbf86d6883869f16a46f65
author Scott Chacon &lt;schacon@gmail.com&gt; 1220421161 -0700
committer Scott Chacon &lt;schacon@gmail.com&gt; 1220421161 -0700

added chapters on the packfile and how git stores objects
</code></pre>

<p>и можем видеть что родитель, <code>ab04d88</code> это куда наша ветка master в данный момент указывает. Теперь, мы рекурсивно извлекаем это дерево и затем останавливаемся, так как мы знаем что у нас есть все что идет до этой точки. Вы можете заставить Git дважды проверить, то что у нас уже есть все, с помощью параметра '--recover'. Просмотрите документацию <a href="http://www.kernel.org/pub/software/scm/git/docs/git-http-fetch.html">git http-fetch</a> чтобы получить больше подробностей.</p>

<p>Если извлечение одного из свободных объектов потерпит неудачу, Git будет скачивать индексы пакфайлов пытаясь найти sha значение которое ему нужно, и затем скачает этот пакфайл.</p>

<p>Это важно если вы используете git сервер который обслуживает репозитории этим способом чтобы реализовать хуки post-recieve которые запускаются командой 'git update-server-info' каждый раз или произойдет путаница.</p>

<h3>Извлечение данных с помощью выгрузки пакетов</h3>

<p>В более умных протоколах, извлечение объектов более эффективно. Сокет открыт, или через ssh или другой порт 9418 (в случае протокола git://), и команда <a href="http://www.kernel.org/pub/software/scm/git/docs/git-fetch-pack.html">git fetch-pack</a> на клиенте начнет сообщаться с форком процесса <a href="http://www.kernel.org/pub/software/scm/git/docs/git-upload-pack.html">git upload-pack</a> на сервере..</p>

<p>Затем сервер сообщит клиенту которое SHA значение он имеет для каждой ref, и клиент определит что ему нужно и ответит списком SHA значений которые ему нужныи которые у него уже есть.</p>

<p>В этот момент, сервер сгенерирует пакфайл со всеми объектами которые нужны клиенту и передаст их клиенту.</p>

<p>Давайте взглянем на пример.</p>

<p>Клиент соединяется и посылает заголовок запроса. Команда клон</p>

<pre><code>$ git clone git://myserver.com/project.git
</code></pre>

<p>производит следующий запрос:</p>

<pre><code>0032git-upload-pack /project.git\000host=myserver.com\000
</code></pre>

<p>Первые 4 байта содержат 16ое длину строки (включая 4 байта длины строки и символ окончания строки если таковой имеется). Следующее это команды и их аргументы. Затем идет нулевой байт и затем данные о хосте. Запрос заканчивается нулевым байтом.</p>

<p>Запрос обрабатывается и конвертируется в вызов git-upload-pack:</p>

<pre><code>$ git-upload-pack /path/to/repos/project.git
</code></pre>

<p>Это немедленно возвращает информацию репозитория:</p>

<pre><code>007c74730d410fcb6603ace96f1dc55ea6196122532d HEAD\000multi_ack thin-pack side-band side-band-64k ofs-delta shallow no-progress
003e7d1665144a3a975c05f1f43902ddaf084e784dbe refs/heads/debug
003d5a3f6be755bbb7deae50065988cbfa1ffa9ab68a refs/heads/dist
003e7e47fe2bd8d01d481f44d7af0531bd93d3b21c01 refs/heads/local
003f74730d410fcb6603ace96f1dc55ea6196122532d refs/heads/master
0000
</code></pre>

<p>Каждая строка начинается с 4 байт строки длины объявления в hex. Эта часть завершается строкой с длиной объявления 0000.</p>

<p>Это отсылается назад клиенту. Клиент отвечает другим запросом:</p>

<pre><code>0054want 74730d410fcb6603ace96f1dc55ea6196122532d multi_ack side-band-64k ofs-delta
0032want 7d1665144a3a975c05f1f43902ddaf084e784dbe
0032want 5a3f6be755bbb7deae50065988cbfa1ffa9ab68a
0032want 7e47fe2bd8d01d481f44d7af0531bd93d3b21c01
0032want 74730d410fcb6603ace96f1dc55ea6196122532d
00000009done
</code></pre>

<p>Это оправлено чтобы открыть процесс git-upload-pack который затем создат поток и вернет его назад как заключительный ответ:</p>

<pre><code>"0008NAK\n"
"0023\002Counting objects: 2797, done.\n"
"002b\002Compressing objects:   0% (1/1177)   \r"
"002c\002Compressing objects:   1% (12/1177)   \r"
"002c\002Compressing objects:   2% (24/1177)   \r"
"002c\002Compressing objects:   3% (36/1177)   \r"
"002c\002Compressing objects:   4% (48/1177)   \r"
"002c\002Compressing objects:   5% (59/1177)   \r"
"002c\002Compressing objects:   6% (71/1177)   \r"
"0053\002Compressing objects:   7% (83/1177)   \rCompressing objects:   8% (95/1177)   \r"
...
"005b\002Compressing objects: 100% (1177/1177)   \rCompressing objects: 100% (1177/1177), done.\n"
"2004\001PACK\000\000\000\002\000\000\n\355\225\017x\234\235\216K\n\302"...
"2005\001\360\204{\225\376\330\345]z2673"...
...
"0037\002Total 2797 (delta 1799), reused 2360 (delta 1529)\n"
...
"&lt;\276\255L\273s\005\001w0006\001[0000"
</code></pre>

<p>Просмотрите предыдущую главу Пакфайл чтобы получить описание формата данных пакфайла в ответе.</p>

<h3>Выполнение push</h3>

<p>Выполнение push через git и ssh протоколы похоже, но проще. По существу происходит то что клиент запрашивает экземпляр receive-pack, который запускается если клиент имеет доступ, затем сервер возвращает все sha значения заголовков ссылок, которые у него есть опять и клиент генерирует пакфайл всего что требуется серверу (обычно только если то что на сервере это прямой предок того для чего и выполняется push) и посылает этот пакфайл в исходящий поток, где сервер или сохраняет его на диске и строит индекс для него, или распаковывает его (если там не много объектов)</p>

<p>Это весь процесс выполняется с помощью команды <a href="http://www.kernel.org/pub/software/scm/git/docs/git-send-pack.html">git send-pack</a> на клиенте, которая вызывается <a href="http://www.kernel.org/pub/software/scm/git/docs/git-push.html">git push</a> и <a href="http://www.kernel.org/pub/software/scm/git/docs/git-receive-pack.html">git receive-pack</a>командой на стороне сервера, которая вызывается процессом соединения ssh или демоном git (если это открытый push сервер).</p>


  </div>
  
  <div class="span-21">
    <hr/>
    <div class="center"><a href="7_raw_git.html">Prev</a>  <a href="7_Глоссарий.html">Next</a></div>
    <hr/>
  </div>
  
  <div class="span-17 footer">
  	<div class="menu">
  		This book is maintained by Scott Chacon, and hosting is donated by GitHub.
  		<br>
  		Please email me at <a href="mailto:schacon@gmail.com">schacon@gmail.com</a>
  		with patches, suggestions and comments.
	  </div>
  </div>
  <div class="span-4 last center">
    <a href="http://github.com"><img src="assets/images/github.png" alt="github logo"></a>
  </div>
  
</div>

<script type="text/javascript">
var pageTracker = _gat._getTracker("UA-82337-12");
pageTracker._initData();
pageTracker._trackPageview();
</script>
<script src="http://static.getclicky.com/40584.js" type="text/javascript"></script>
<noscript><p><img alt="Clicky" src="http://in.getclicky.com/40584-db6.gif" /></p></noscript>

</body>
</html>
